!function(){"use strict";var a={ns:{streams:"http://etherx.jabber.org/streams",jabber_client:"jabber:client",xmpp_stanzas:"urn:ietf:params:xml:ns:xmpp-stanzas"},stanzas:{stream:{open:function(b){return'<stream:stream to="'+b+'" '+'xmlns="'+a.ns.jabber_client+'" '+'xmlns:stream="'+a.ns.streams+'" '+'version="1.0">'},close:function(){return"</stream:stream>"}},errors:{iq:function(b,c,d,e){return'<iq to="'+b+'" id="'+c+'" type="error">'+'<error type="'+d+'">'+"<"+e+' xmlns="'+a.ns.xmpp_stanzas+'"/>'+"</error>"+"</iq>"}}},mechanisms:{},transports:{},connections:[],id:function(a){return(a||"")+Date.now()+Math.random()},escape:function(a){return a=a.toString(),a?a.replace(/\&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;"):""},unescape:function(a){return a=a.toString(),a?unescape(a.replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&apos;/g,"'")):""},registerMechanism:function(a,b){this.mechanisms[a]=b},registerTransport:function(a,b){this.transports[a]=b}};window.Lightstring=a,a.Connection=function(b){b&&(this.service=b),this.handlers={},this.callbacks={},this.status="disconnected",this.onOpen=function(){},this.onConnecting=function(){},this.onConnected=function(){},this.onError=function(){},this.onClose=function(){},this.onFailure=function(){},this.onDisconnecting=function(){},this.onAuthFailure=function(){},this.onStanza=function(){},this.onOut=function(){},a.connections.push(this)},a.Connection.prototype={connect:function(b,c){function d(a){var b=document.createElement("a");return b.href=a,b.protocol.replace(":","")}if(this.onConnecting(),this.jid=new a.JID(b),c&&(this.password=c),this.jid.bare&&this.service){var e=d(this.service);e.match("http")?this.transport=new a.transports.BOSH(this.service,this.jid):e.match("ws")&&(this.transport=new a.transports.WebSocket(this.service,this.jid));var f=this;this.transport.onOpen=function(){f.onOpen()},this.transport.onError=function(a){f.onError(a)},this.transport.onClose=function(a){f.onClose(a),f.status="disconnected"},this.transport.onOut=function(a){setTimeout(function(){f.onOut(a)},0)},this.transport.onStanza=function(b){if(b=new a.Stanza(b),f.onStanza(b),f.mechanism&&"connected"!==f.status)f.mechanism.onStanza(b);else if("stream:features"===b.name){var c=b.getChild("mechanisms","urn:ietf:params:xml:ns:xmpp-sasl");if(!c)return;for(var d=c.getChildren("mechanism"),e=0;e<d.length;e++){var g=d[e].text();if(a.mechanisms[g])return f.mechanism=a.mechanisms[g],f.mechanism.onError=function(){delete f.mechanism,f.status="auth failed",f.onAuthFailure()},f.mechanism.onSuccess=function(){delete f.mechanism,f.status="connected",f.onConnected()},f.mechanism.start(f),void 0}DEBUG("Server doesn't support any of the SASL mechanisms"),this.close()}if("iq"===b.name){var h=b.attr("id"),i=f.callbacks[h];if(!i)return;var j=b.attr("type");"result"===j&&i.success?i.success.call(f,b):"error"===j&&i.error&&i.error.call(f,b),delete f.callbacks[h]}},this.transport.open(function(b){var c=a.stanzas.stream.open(f.jid.domain);f.transport.send(c)})}},send:function(b,c,d){var e;if(e=b instanceof a.Stanza?b:new a.Stanza(b),"message"!==e.name&&"presence"!==e.name&&"iq"!==e.name||e.attrs.from||(e.attrs.from=this.jid.full),"iq"===e.name){var f={success:c,error:d},g=e.attr("id");g||e.attr("id",a.id()),this.callbacks[e.attr("id")]=f}return this.transport.send(e.toString()),e},disconnect:function(){this.onDisconnecting();var b=a.stanzas.stream.close();this.transport.send(b),this.onOut(b),this.transport.close()}}}(window),function(){"use strict";function a(a,b){this.name=a,this.parent=null,this.attrs=b||{},this.children=[]}function b(a){return a.replace(/\&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}function c(a){return a.replace(/\&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}a.prototype.is=function(a,b){return this.getName()==a&&(!b||this.getNS()==b)},a.prototype.getName=function(){return this.name.indexOf(":")>=0?this.name.substr(this.name.indexOf(":")+1):this.name},a.prototype.getNS=function(){if(this.name.indexOf(":")>=0){var a=this.name.substr(0,this.name.indexOf(":"));return this.findNS(a)}return this.findNS()},a.prototype.findNS=function(a){if(a){var b="xmlns:"+a;if(this.attrs[b])return this.attrs[b];if(this.parent)return this.parent.findNS(a)}else{if(this.attrs.xmlns)return this.attrs.xmlns;if(this.parent)return this.parent.findNS()}},a.prototype.getChild=function(a,b){return this.getChildren(a,b)[0]},a.prototype.getChildren=function(a,b){for(var c=[],d=0;d<this.children.length;d++){var e=this.children[d];!e.getName||e.getName()!=a||b&&e.getNS()!=b||c.push(e)}return c},a.prototype.getChildByAttr=function(a,b,c,d){return this.getChildrenByAttr(a,b,c,d)[0]},a.prototype.getChildrenByAttr=function(a,b,c,d){for(var e=[],f=0;f<this.children.length;f++){var g=this.children[f];!g.attrs||g.attrs[a]!=b||c&&g.getNS()!=c||e.push(g),d&&g.getChildrenByAttr&&e.push(g.getChildrenByAttr(a,b,c,!0))}return d&&(e=[].concat.apply([],e)),e},a.prototype.getText=function(){for(var a="",b=0;b<this.children.length;b++){var c=this.children[b];"string"==typeof c&&(a+=c)}return a},a.prototype.getChildText=function(a){for(var b=null,c=0;c<this.children.length;c++){var d=this.children[c];b||d.name!=a||(b=d.getText())}return b},a.prototype.root=function(){return this.parent?this.parent.root():this},a.prototype.tree=a.prototype.root,a.prototype.up=function(){return this.parent?this.parent:this},a.prototype.c=function(b,c){return this.cnode(new a(b,c))},a.prototype.cnode=function(a){return this.children.push(a),a.parent=this,a},a.prototype.t=function(a){return this.children.push(a),this},a.prototype.remove=function(a,b){var c;return c="string"==typeof a?function(c){return!(c.is&&c.is(a,b))}:function(b){return b!==a},this.children=this.children.filter(c),this},a.prototype.clone=function(){var b=new a(this.name,{});for(var c in this.attrs)this.attrs.hasOwnProperty(c)&&(b.attrs[c]=this.attrs[c]);for(var d=0;d<this.children.length;d++){var e=this.children[d];b.cnode(e.clone?e.clone():e)}return b},a.prototype.text=function(a){return a&&1==this.children.length?(this.children[0]=a,this):this.getText()},a.prototype.attr=function(a,b){return b?(this.attrs||(this.attrs={}),this.attrs[a]=b,this):this.attrs[a]},a.prototype.toString=function(){var a="";return this.write(function(b){a+=b}),a},a.prototype.write=function(a){a("<"),a(this.name);for(var d in this.attrs){var e=this.attrs[d];(e||""===e||0===e)&&(a(" "),a(d),a('="'),"string"!=typeof e&&(e=e.toString()),a(b(e)),a('"'))}if(0==this.children.length)a("/>");else{a(">");for(var f=0;f<this.children.length;f++){var g=this.children[f];(g||0===g)&&(g.write?g.write(a):"string"==typeof g?a(c(g)):g.toString&&a(c(g.toString())))}a("</"),a(this.name),a(">")}},Lightstring.Element=a}(),function(){"use strict";var a=function(a){this.local=null,this.domain=null,this.resource=null,a&&(this.full=a.toString())};a.prototype={toString:function(){return this.full},equals:function(a){return a instanceof Lightstring.JID||(a=new Lightstring.JID(a)),this.local===a.local&&this.domain===a.domain&&this.resource===a.resource},toBare:function(){var a=this;return a.resource=null,a},get bare(){return this.domain?this.local?this.local+"@"+this.domain:this.domain:null},set bare(a){if(a){var b=a.indexOf("/");-1!=b&&(a=a.substring(0,b)),b=a.indexOf("@"),-1==b?(this.local=null,this.domain=a):(this.local=a.substring(0,b),this.domain=a.substring(b+1))}},get full(){if(!this.domain)return null;var a=this.domain;return this.local&&(a=this.local+"@"+a),this.resource&&(a=a+"/"+this.resource),a},set full(a){if(a){var b=a.indexOf("/");-1==b?this.resource=null:(this.resource=a.substring(b+1),a=a.substring(0,b)),b=a.indexOf("@"),-1==b?(this.local=null,this.domain=a):(this.local=a.substring(0,b),this.domain=a.substring(b+1))}}},Lightstring.JID=a}(),function(){"use strict";var a=document.implementation.createDocument(null,"dummy",null),b=new DOMParser;new XMLSerializer;var c=function(a){var c=b.parseFromString(a,"text/xml").documentElement;return"parsererror"===c.tagName,c},d=function(a){if(1===a.nodeType||9===a.nodeType){for(var b={},c=0,e=a.attributes.length;e>c;c++)b[a.attributes[c].name]=a.attributes[c].value;for(var f=new Lightstring.Element(a.tagName,b),c=0,e=a.childNodes.length;e>c;c++)3===a.childNodes[c].nodeType?f.t(a.childNodes[c].nodeValue).up():f.cnode(d(a.childNodes[c]));return f}},e=function(a){if("string"==typeof a){var b=c(a);return d(b)}return a instanceof Lightstring.Element?a:null};Lightstring.Stanza=e,Lightstring.doc=a}(),function(a){"use strict";var b=window.WebSocket||window.MozWebSocket||void 0,c=function(a){this.service=a};c.prototype.onRawIn=function(){},c.prototype.onRawOut=function(){},c.prototype.onStanza=function(){},c.prototype.onOut=function(){},c.prototype.onError=function(){},c.prototype.onClose=function(){},c.prototype.open=function(a){if(!b)return a(new Error("WebSocket not supported."));this.socket=new b(this.service,"xmpp");var c=this;this.socket.addEventListener("open",function(){var b=void 0;"xmpp"!==this.protocol&&(b=new Error("XMPP protocol not supported by the WebSocket server.")),a(b)}),this.socket.addEventListener("error",function(a){c.onError(a)}),this.socket.addEventListener("close",function(a){c.onClose(a)}),this.socket.addEventListener("message",function(a){c.onRawIn(a.data),c.onStanza(a.data)})},c.prototype.close=function(){this.socket.close()},c.prototype.send=function(a){var b=a.toString();this.socket.send(b),this.onOut(b),this.onRawOut(b)},a.registerTransport("WebSocket",c)}(Lightstring),function(a){"use strict";a.registerMechanism("PLAIN",{conn:null,onSuccess:function(){},onError:function(){},start:function(a){this.conn=a;var b=btoa(a.jid.bare+"\0"+a.jid.local+"\0"+a.password);a.send('<auth xmlns="urn:ietf:params:xml:ns:xmpp-sasl" mechanism="PLAIN">'+b+"</auth>")},onStanza:function(b){var c=this.conn,d=this;if("success"===b.name)c.send("<stream:stream to='"+c.jid.domain+"'"+" xmlns='jabber:client'"+" xmlns:stream='http://etherx.jabber.org/streams'"+" version='1.0'/>");else if("stream:features"===b.name){var e='<iq type="set"><bind xmlns="urn:ietf:params:xml:ns:xmpp-bind">'+(c.jid.resource?"<resource>"+c.jid.resource+"</resource>":"")+"</bind>"+"</iq>";c.send(e,function(b){c.jid=new a.JID(b.getChild("bind").getChild("jid").text()),c.send('<iq type="set"><session xmlns="urn:ietf:params:xml:ns:xmpp-session"/></iq>',function(){d.onSuccess()})},function(){d.onError()})}else"failure"===b.name&&d.onError()}})}(window.Lightstring);